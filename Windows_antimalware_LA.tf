provider "azurerm" { }

data "azurerm_resource_group" "test" {
  name     = "E5562304-SouthIndia-01"
    }

data "azurerm_log_analytics_workspace" "test" {
  name                = "Paranworkspace"
  resource_group_name = "${data.azurerm_resource_group.test.name}"
  }
    resource "azurerm_storage_account" "sa" {
    name = "paranstore1"
    resource_group_name = "${data.azurerm_resource_group.test.name}"
    location = "CentralIndia"
    account_tier = "Standard"
    account_replication_type = "LRS"
    }

    resource "azurerm_public_ip" "pip"  {
    name = "Paranpip"
    location="CentralIndia"
    resource_group_name = "${data.azurerm_resource_group.test.name}"
    public_ip_address_allocation="dynamic"
    }



    resource "azurerm_virtual_network" "vnet" {
    name = "paranvnet"
    address_space = ["10.0.0.0/16"]
    location = "CentralIndia"
    resource_group_name = "${data.azurerm_resource_group.test.name}"


  tags {
    BUC             = "4011.501000.9517..0000.0000.0000"
    AppGroup        = "AppGroupPlaceholder"
    AppGroupEmail   = "AppGroupEmailPlaceholder@fisglobal.com"
    EnvironmentType = "Dev"
    CustomerCRMID   = "AIA"
    ExpirationDate  = "Never"
  }
    }

    resource "azurerm_subnet" "sub" {
    name = "subnet1"
    resource_group_name = "${data.azurerm_resource_group.test.name}"
    virtual_network_name="${azurerm_virtual_network.vnet.name}"
    address_prefix = "10.0.1.0/24"
    }

    resource "azurerm_network_interface" "nic" {
    name = "parannic"
    location = "CentralIndia"
    resource_group_name = "${data.azurerm_resource_group.test.name}"

    ip_configuration {
    name = "Server2016"
    subnet_id = "${azurerm_subnet.sub.id}"
    private_ip_address_allocation = "dynamic"
    public_ip_address_id = "${azurerm_public_ip.pip.id}"
    }
    tags {
        BUC             = "4011.501000.9517..0000.0000.0000"
        AppGroup        = "AppGroupPlaceholder"
        AppGroupEmail   = "AppGroupEmailPlaceholder@fisglobal.com"
        EnvironmentType = "Dev"
        CustomerCRMID   = "AIA"
        ExpirationDate  = "Never"
    }
    }

    resource "azurerm_managed_disk" "test" {
    name = "parandisk"
    location="CentralIndia"
    resource_group_name = "${data.azurerm_resource_group.test.name}"
    storage_account_type = "Standard_LRS"
    create_option = "Empty"
    disk_size_gb = "1023"
    }


resource "azurerm_virtual_machine" "vm" {
name = "paranvm"
location="CentralIndia"
resource_group_name = "${data.azurerm_resource_group.test.name}"
network_interface_ids = ["${azurerm_network_interface.nic.id}"]
vm_size = "Standard_DS1_v2"
delete_os_disk_on_termination = "true"
delete_data_disks_on_termination = "true"

    storage_image_reference {
    publisher = "MicrosoftWindowsServer"
    offer = "WindowsServer"
    sku = "2016-Datacenter"
    version = "latest"
    }

    storage_os_disk {
    name = "datadisk_new_2018_01"
    caching = "ReadWrite"
    create_option = "FromImage"
    managed_disk_type="Standard_LRS"
    }

    storage_data_disk {
    name = "datadisk_new"
    managed_disk_type = "Standard_LRS"
    create_option = "Empty"
    lun = 0
    disk_size_gb = "1023"
    }

    os_profile {
    computer_name = "hostname"
    admin_username = "testadmin"
    admin_password = "Password1234!"
    }

    os_profile_windows_config {
    provision_vm_agent = "true"
    enable_automatic_upgrades = "true"
    winrm {
    protocol = "http"
    certificate_url =""
    }
    }

  tags {
    BUC               = "4011.501000.9517..0000.0000.0000"
    AppGroup          = "AppGroupPlaceholder"
    AppGroupEmail     = "AppGroupEmailPlaceholder@fisglobal.com"
    EnvironmentType   = "Dev"
    CustomerCRMID     = "AIA"
    ExpirationDate    = "Never"
    Tier              = "System"
    MaintenanceWindow = "*/2-5/*/1,3,5,7,9,11/0-6"
    Scheduling        = "Never"
    SLA               = "None"
    SolutionCentralID = "123"
  }
}


resource "azurerm_virtual_machine_extension" "test" {
name                 = "IaaSAntimalware"
location             = "CentralIndia"
resource_group_name  = "${data.azurerm_resource_group.test.name}"
virtual_machine_name = "${azurerm_virtual_machine.vm.name}"
publisher            = "Microsoft.Azure.Security"
type                 = "IaaSAntimalware"
type_handler_version = "1.1"
auto_upgrade_minor_version = "true"

settings = <<SETTINGS
    {
        "AntimalwareEnabled": true,
        "RealtimeProtectionEnabled": "true",
        "ScheduledScanSettings": {
            "isEnabled": "true",
            "day": "1",
            "time": "120",
            "scanType": "Quick"
            },
        "Exclusions": {
            "Extensions": "",
            "Paths": "",
            "Processes": ""
            }
    }
SETTINGS
depends_on = ["azurerm_virtual_machine.vm"]
}

resource "azurerm_virtual_machine_extension" "test2" {
  name                       = "LogAnalytics"
  location                   = "CentralIndia"
  resource_group_name        = "${data.azurerm_resource_group.test.name}"
  virtual_machine_name       = "${azurerm_virtual_machine.vm.name}"
  publisher                  = "Microsoft.EnterpriseCloud.Monitoring"
  type                       = "MicrosoftMonitoringAgent"
  type_handler_version       = "1.0"
  auto_upgrade_minor_version = true

  settings = <<SETTINGS
	{
	    "workspaceId": "${data.azurerm_log_analytics_workspace.test.workspace_id}"
	}
SETTINGS

  protected_settings = <<protectedsettings
      {
          "workspaceKey" :  "${data.azurerm_log_analytics_workspace.test.primary_shared_key}"
      }
protectedsettings

  depends_on = ["azurerm_virtual_machine.vm"]
}
